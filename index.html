<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ronde de S√©curit√©</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 10px; background: #f4f7f6; margin: 0; }
        /* Cette bo√Æte "capture" englobe TOUT pour que le PDF soit complet */
        #capture { background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; width: 550px; margin: auto; }
        .item { border-bottom: 1px solid #eee; padding: 15px 0; }
        .btns { display: flex; gap: 10px; margin-top: 10px; }
        button { padding: 12px; border-radius: 6px; border: 1px solid #ccc; cursor: pointer; font-weight: bold; }
        .ok.active { background: #27ae60; color: white; border-color: #27ae60; }
        .bad.active { background: #e74c3c; color: white; border-color: #e74c3c; }
        /* La case qui doit appara√Ætre quand il y a un d√©faut */
        .defect-area { display: none; margin-top: 10px; background: #fff5f5; padding: 10px; border: 1px solid #e74c3c; border-radius: 5px; }
        canvas { border: 1px solid #000; width: 100%; height: 180px; background: #fff; touch-action: none; margin-top: 10px; }
        #mainBtn { width: 100%; padding: 20px; background: #2980b9; color: white; font-size: 1.3rem; border: none; border-radius: 12px; margin-top: 20px; }
    </style>
</head>
<body>

<div id="capture">
    <h2 style="text-align:center;">üöõ Ronde de S√©curit√©</h2>
    
    <div style="margin-bottom: 20px;">
        <p><b>Chauffeur :</b> <input type="text" id="driver" style="width:100%; padding:8px; border:1px solid #ccc;"></p>
        <p><b>Camion # :</b> <input type="text" id="unit" style="width:100%; padding:8px; border:1px solid #ccc;"></p>
    </div>

    <div id="checklist"></div>

    <div style="margin-top:20px;">
        <h3>‚úçÔ∏è Signature</h3>
        <canvas id="sig"></canvas>
    </div>
</div>

<button onclick="genererPDF()" id="mainBtn">üíæ CR√âER LE RAPPORT PDF</button>

<script>
    const tasks = ["Freins", "Pneus", "Lumi√®res", "Direction", "Attelage", "Huile et Fluides", "Miroirs", "Essuie-glaces"];
    const checklist = document.getElementById('checklist');

    tasks.forEach(t => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<strong>${t}</strong>
            <div class="btns">
                <button type="button" onclick="setStatus('${t}','OK',this)" class="ok">OK</button>
                <button type="button" onclick="setStatus('${t}','X',this)" class="bad">D√âFAUT</button>
            </div>
            <div id="area-${t}" class="defect-area">
                <textarea style="width:100%; height:60px;" placeholder="D√©tails du probl√®me..."></textarea>
                <br>
                <button type="button" style="width:100%; margin-top:5px; background:#9b59b6; color:white; border:none; padding:10px; border-radius:5px;">üì∑ PHOTO</button>
            </div>`;
        checklist.appendChild(div);
    });

    function setStatus(t, status, btn) {
        const parent = btn.parentElement;
        parent.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Affiche la case rouge seulement si on clique sur D√âFAUT
        const area = document.getElementById('area-' + t);
        area.style.display = (status === 'X') ? 'block' : 'none';
    }

    const canvas = document.getElementById('sig');
    const ctx = canvas.getContext('2d');
    let drawing = false;
    canvas.width = canvas.offsetWidth;
    
    const getPos = (e) => {
        const r = canvas.getBoundingClientRect();
        const cx = e.touches ? e.touches[0].clientX : e.clientX;
        const cy = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: cx - r.left, y: cy - r.top };
    };

    canvas.onmousedown = canvas.ontouchstart = (e) => { 
        drawing = true; ctx.beginPath(); 
        const p = getPos(e); ctx.moveTo(p.x, p.y);
    };
    canvas.onmouseup = canvas.ontouchend = () => drawing = false;
    canvas.onmousemove = canvas.ontouchmove = (e) => {
        if(!drawing) return;
        const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke();
        if(e.touches) e.preventDefault();
    };

    function genererPDF() {
        const btn = document.getElementById('mainBtn');
        const unit = document.getElementById('unit').value || "Camion";
        btn.innerText = "G√©n√©ration...";
        
        const element = document.getElementById('capture');
        const opt = {
            margin: 0.1,
            filename: 'Inspection_'+unit+'.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).save().then(() => {
            btn.innerText = "‚úÖ PDF T√âL√âCHARG√â";
        });
    }
</script>
</body>
</html>
      
