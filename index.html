<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ronde de S√©curit√© Officielle</title>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 15px; background: #f4f7f6; margin: 0; }
        .item { background: white; padding: 15px; margin-bottom: 12px; border-radius: 8px; border: 1px solid #ddd; }
        .btns { display: flex; gap: 10px; margin-top: 10px; }
        button { padding: 12px; border-radius: 6px; border: 1px solid #ccc; cursor: pointer; font-weight: bold; }
        .ok.active { background: #27ae60; color: white; border-color: #27ae60; }
        .bad.active { background: #e74c3c; color: white; border-color: #e74c3c; }
        .defect-area { display: none; margin-top: 10px; background: #fff5f5; padding: 10px; border-radius: 5px; }
        textarea { width: 100%; height: 70px; border: 1px solid #ccc; border-radius: 4px; }
        canvas { border: 2px dashed #aaa; width: 100%; height: 180px; background: #fff; touch-action: none; margin-top: 10px; }
        h2 { text-align: center; color: #2c3e50; margin-top: 0; }
        /* Style sp√©cial pour que le PDF ne soit pas coup√© */
        #form-container { background: #f4f7f6; padding: 15px; }
    </style>
</head>
<body>

<div id="form-container">
    <h2>üöõ Ronde de S√©curit√©</h2>

    <div class="item">
        <label><b>Nom du Chauffeur :</b></label>
        <input type="text" id="driver" style="width:95%; padding:10px; margin-top:5px; border:1px solid #ddd;">
        <br><br>
        <label><b>Camion # :</b></label>
        <input type="text" id="unit" style="width:95%; padding:10px; margin-top:5px; border:1px solid #ddd;">
    </div>

    <div id="checklist"></div>

    <div class="item">
        <h3>‚úçÔ∏è Signature Obligatoire</h3>
        <canvas id="sig"></canvas>
        <button type="button" onclick="clearSig()" style="margin-top:10px;">Effacer la signature</button>
    </div>

    <button onclick="envoyerRapport()" id="mainBtn" style="width:100%; padding:20px; background:#27ae60; color:white; font-size:1.3rem; border:none; border-radius:12px; margin-top:20px;">‚úÖ SOUMETTRE ET CR√âER PDF</button>
</div>

<script>
    // Tes codes officiels (V√©rifi√©s)
    (function() { emailjs.init("_Nvq5id_TVKKPb8mF"); })();

    const tasks = ["Freins", "Pneus", "Lumieres", "Direction", "Attelage", "Huile et Fluides", "Miroirs", "Essuie-glaces"];
    const checklist = document.getElementById('checklist');

    tasks.forEach(t => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<strong>${t}</strong>
        <div class="btns">
            <button type="button" onclick="setStatus('${t}','OK',this)" class="ok">OK</button>
            <button type="button" onclick="setStatus('${t}','X',this)" class="bad">X</button>
        </div>
        <div id="area-${t}" class="defect-area">
            <textarea placeholder="D√©crivez le probl√®me ici..."></textarea>
            <input type="file" id="f-${t}" accept="image/*" capture="camera" style="display:none">
            <button type="button" style="background:#9b59b6;color:white;width:100%;border:none;padding:10px;margin-top:5px;border-radius:5px;" onclick="document.getElementById('f-${t}').click()">üì∑ PRENDRE PHOTO</button>
        </div>`;
        checklist.appendChild(div);
    });

    function setStatus(t, s, btn) {
        btn.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('area-'+t).style.display = (s === 'X') ? 'block' : 'none';
    }

    const canvas = document.getElementById('sig');
    const ctx = canvas.getContext('2d');
    let drawing = false;
    canvas.width = canvas.offsetWidth;
    const getPos = (e) => {
        const r = canvas.getBoundingClientRect();
        const cx = e.touches ? e.touches[0].clientX : e.clientX;
        const cy = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: cx - r.left, y: cy - r.top };
    };
    canvas.onmousedown = canvas.ontouchstart = (e) => { 
        drawing = true; ctx.beginPath(); 
        const p = getPos(e); ctx.moveTo(p.x, p.y);
        if(e.touches) e.preventDefault();
    };
    canvas.onmouseup = canvas.ontouchend = () => drawing = false;
    canvas.onmousemove = canvas.ontouchmove = (e) => {
        if(!drawing) return;
        const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke();
        if(e.touches) e.preventDefault();
    };
    function clearSig() { ctx.clearRect(0,0,canvas.width,canvas.height); }

    function envoyerRapport() {
        const btn = document.getElementById('mainBtn');
        const unit = document.getElementById('unit').value;
        const driver = document.getElementById('driver').value;
        
        if(!unit || !driver) { alert("SVP remplissez le nom et le # d'unit√©"); return; }
        
        btn.innerText = "Envoi en cours...";

        // Envoi EmailJS
        emailjs.send("service_t31ah75", "template_a3zj2se", {
            unit: unit,
            driver: driver,
            message: "Nouvelle inspection effectu√©e."
        }).then(() => {
            genererPDF(unit);
            alert("Rapport envoy√© par courriel !");
            btn.innerText = "‚úÖ R√âUSSI";
        }).catch((err) => {
            console.error(err);
            genererPDF(unit);
            alert("Note: PDF cr√©√©, mais erreur de courriel.");
            btn.innerText = "PDF CR√â√â";
        });
    }

    function genererPDF(unit) {
        const element = document.getElementById('form-container');
        const opt = {
            margin: 0,
            filename: 'Inspection_'+unit+'.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { 
                scale: 2, 
                useCORS: true, 
                scrollY: 0,
                windowHeight: element.scrollHeight // Capture toute la hauteur
            },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }
</script>
</body>
</html>
