<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ronde de S√©curit√©</title>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 10px; background: #f4f7f6; }
        .item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; }
        .btns { display: flex; gap: 10px; margin-top: 10px; }
        button { padding: 12px; border-radius: 5px; border: 1px solid #ccc; cursor: pointer; font-weight: bold; }
        .ok.active { background: #27ae60; color: white; }
        .bad.active { background: #e74c3c; color: white; }
        .defect-area { display: none; margin-top: 10px; background: #fff5f5; padding: 10px; }
        textarea { width: 100%; height: 60px; margin-bottom: 10px; }
        canvas { border: 2px dashed #999; width: 100%; height: 150px; background: #fff; touch-action: none; }
    </style>
</head>
<body>
    <h2 style="text-align:center;">üöõ Ronde de S√©curit√©</h2>
    <div class="item">
        <input type="text" id="driver" placeholder="Nom du Chauffeur" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd;">
        <input type="text" id="unit" placeholder="Camion #" style="width:100%; padding:10px; border:1px solid #ddd;">
    </div>

    <div id="checklist"></div>

    <div class="item">
        <h3>‚úçÔ∏è Signature</h3>
        <canvas id="sig"></canvas>
        <button onclick="clearSig()">Effacer</button>
    </div>

    <button onclick="envoyerRapport()" id="mainBtn" style="width:100%; padding:20px; background:#27ae60; color:white; font-size:1.2rem; border:none; border-radius:10px;">‚úÖ ENVOYER ET CR√âER PDF</button>

    <script>
        // Initialisation avec ta Public Key officielle
        (function() { emailjs.init("_Nvq5id_TVKKPb8mF"); })(); 

        const tasks = ["Freins", "Pneus", "Lumieres", "Direction", "Attelage", "Huile et Fluides", "Miroirs", "Essuie-glaces"];
        const checklist = document.getElementById('checklist');

        tasks.forEach(t => {
            const div = document.createElement('div');
            div.className = 'item';
            div.innerHTML = `<strong>${t}</strong>
            <div class="btns">
                <button type="button" onclick="setStatus('${t}','OK',this)" class="ok">OK</button>
                <button type="button" onclick="setStatus('${t}','X',this)" class="bad">X</button>
            </div>
            <div id="area-${t}" class="defect-area">
                <textarea id="txt-${t}" placeholder="D√©tails du probl√®me..."></textarea>
                <input type="file" id="f-${t}" accept="image/*" capture="camera" style="display:none">
                <button type="button" onclick="document.getElementById('f-${t}').click()" style="background:#9b59b6; color:white; width:100%; border:none; padding:10px;">üì∑ PHOTO DU D√âFAUT</button>
            </div>`;
            checklist.appendChild(div);
        });

        function setStatus(t, s, btn) {
            btn.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('area-'+t).style.display = (s === 'X') ? 'block' : 'none';
        }

        const canvas = document.getElementById('sig');
        const ctx = canvas.getContext('2d');
        let drawing = false;
        canvas.width = canvas.offsetWidth;
        canvas.onmousedown = canvas.ontouchstart = (e) => { drawing = true; ctx.beginPath(); };
        canvas.onmouseup = canvas.ontouchend = () => drawing = false;
        canvas.onmousemove = canvas.ontouchmove = (e) => {
            if(!drawing) return;
            const r = canvas.getBoundingClientRect();
            const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
            const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
            ctx.lineTo(x, y); ctx.stroke();
            if(e.touches) e.preventDefault();
        };
        function clearSig() { ctx.clearRect(0,0,canvas.width,canvas.height); }

        function envoyerRapport() {
            const btn = document.getElementById('mainBtn');
            const unit = document.getElementById('unit').value;
            const driver = document.getElementById('driver').value;
            
            if(!unit || !driver) { alert("Veuillez entrer le nom et le num√©ro d'unit√© !"); return; }
            
            btn.innerText = "Envoi en cours...";

            // Envoi avec tes codes : service_t31ah75 et template_a3zj2se
            emailjs.send("service_t31ah75", "template_a3zj2se", {
                unit: unit,
                driver: driver,
                message: "Inspection compl√©t√©e pour l'unit√© " + unit
            }).then(() => {
                alert("Rapport envoy√© √† jacquesperrier.auditeur@gmail.com !");
                html2pdf().from(document.body).save('Inspection_' + unit + '.pdf');
                btn.innerText = "‚úÖ ENVOY√â - PDF CR√â√â";
            }).catch((err) => {
                console.log(err);
                alert("Erreur d'envoi. Le PDF sera tout de m√™me cr√©√©.");
                html2pdf().from(document.body).save('Inspection.pdf');
                btn.innerText = "PDF CR√â√â";
            });
        }
    </script>
</body>
</html>
